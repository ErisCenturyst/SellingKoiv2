@model IEnumerable<SellingKoi.Models.OrtherShorten>

@{
    ViewData["Title"] = "Order Management";
}

<div class="justify-content-between align-items-center mb-3">
    <h2>Quản lí đơn hàng</h2>

    <div class="mb-3">
        <form asp-action="SearchOrderByID" method="get" class="form-inline">
            <input type="text" name="searchId" class="form-control mr-2" placeholder="Nhập Order ID" />
            <button type="submit" class="btn btn-primary">Tìm kiếm</button>
        </form>
    </div>
</div>

<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>Order ID</th>
            <th>
                <a asp-action="OrderShortenedManagementSort" asp-route-sortOrder="@ViewBag.DepartureFromSortParm">Ngày khởi hành từ</a>
            </th>
            <th>Ngày khởi hành đến</th>
            <th>
                <a asp-action="OrderShortenedManagementSort" asp-route-sortOrder="@ViewBag.RegistrationDateSortParm">Ngày đặt</a>
            </th>
            <th>
                <a asp-action="OrderShortenedManagementSort" asp-route-sortOrder="@ViewBag.RouteNameSortParm">Lộ trình</a>
            </th>
            <th>
                <a asp-action="OrderShortenedManagementSort" asp-route-sortOrder="@ViewBag.StatusSortParm">Trạng thái</a>
            </th>
            <th>Chuyến đi</th>
            <th>Chọn chuyến đi</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var order in Model)
        {
            <tr>
                <td>
                    <a asp-action="DetailsOrder" asp-controller="OrderShorten" asp-route-id="@order.Id">
                        @order.Id
                    </a>
                </td>
                @if (order != null)
                {
                    <td>@order.DepartureFrom?.ToShortDateString()</td>
                    <td>@order.DepartureTo?.ToShortDateString()</td>
                }
                <td>@order.Registration_date.ToShortDateString()</td>
                <td>@order.routename</td>
                <td>
                    <span class="badge @GetStatusBadgeClass(order.Status)">
                        @order.Status
                    </span>
                </td>
                <td>
                    @if (order != null && order.TripNum != null)
                    {
                        @order.TripNum
                    }
                    else
                    {
                        <span>Chưa có chuyến đi</span>
                    }
                </td>
                <td>
                    <form asp-action="UpdateOrder" method="post" class="d-inline">
                        <select name="tripId" class="form-control" @(order.Status != "paid" ? "disabled" : "")>
                            @if (order != null && order.TripNum != null)
                            {
                                <option value="0">-- Hủy chọn chuyến đi --</option>
                            }
                            @if (order != null && order.TripNum == null)
                            {
                                <option value="0">-- Chọn chuyến đi --</option>
                            }
                            
                            @if (ViewBag.TripList != null)
                            {
                                foreach (var trip in ViewBag.TripList as List<Trip>)
                                {   
                                    <option value="@trip.Id">@trip.TripNum</option>
                                }
                            }
                        </select>
                        <input type="hidden" name="orderId" value="@order.Id" />
                        <button type="submit" class="btn btn-success btn-sm" @(order.Status != "paid" ? "disabled" : "")>
                            Cập nhật
                        </button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

@functions {
    string GetStatusBadgeClass(string status)
    {
        return status.ToLower() switch
        {
            "booked" => "bg-warning",
            "paid" => "bg-info",
            "confirmed" => "bg-success",
            "canclebyadmin" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}
